<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="2022-02-28 11:24" author="mert.okan">
        <sql>
            create sequence seq_commission_invoices start 1 increment 50;

            create table commission_invoices
            (
            id int8 not null,
            seller_id int8 not null,
            created_date timestamp not null,
            last_modified_date timestamp not null,
            serial_number varchar not null,
            amount numeric(19, 2) not null,
            net_amount numeric(19, 2) not null,
            vat_amount numeric(19, 2) not null,
            vat_rate numeric(19, 2) not null,
            vat_status_type varchar not null,
            description varchar not null,
            invoice_date timestamp not null,
            store_front_id varchar not null,
            country varchar not null,
            currency varchar not null,
            start_date timestamp not null,
            end_date timestamp not null,
            status smallint not null,
            primary key (id)
            );
        </sql>
    </changeSet>

    <changeSet id="2022-02-28 13:50" author="mert.okan">
        <sql>
            create sequence seq_settlement_items start 1 increment 50;

            create table settlement_items
            (
                id                  int8           not null,
                created_date        timestamp      not null,
                last_modified_date  timestamp      not null,
                item_creation_date  timestamp      not null,
                seller_id           int8           not null,
                transaction_type_id int4           not null,
                commission_amount   numeric(19, 2) not null,
                delivery_date       timestamp,
                payment_date        timestamp      not null,
                primary key (id)
            );

            create table commission_invoice_settlement_items
            (
                commission_invoice_id bigint not null
                    constraint fk_commission_invoice_settlement_items_commission_invoice
                        references commission_invoices,
                settlement_item_id    bigint not null
                    constraint commission_invoice_settlement_items_settlement_item_id_key
                        unique
                    constraint fk_commission_invoice_settlement_items_settlement_item
                        references settlement_items,
                seller_id             bigint not null
            );

            create unique index idx_commission_invoice_settlement_items_settlement_item
                on commission_invoice_settlement_items (settlement_item_id desc);
        </sql>
    </changeSet>
    <changeSet id="2022-03-11 15:15" author="mert.okan">
        <sql>
            create sequence seq_commission_invoice_number_sequences start 1 increment 50;

            create table commission_invoice_number_sequences
            (
            id int8 not null,
            created_date timestamp not null,
            last_modified_date timestamp not null,
            serial_key varchar(3) not null,
            invoice_year int4 not null,
            latest_sequence int8 not null,
            unique (serial_key, invoice_year),
            primary key (id)
            );
        </sql>
    </changeSet>

    <changeSet id="2022-03-25 16:45" author="mert.okan">
        <sql>
            alter table settlement_items add store_front_id int8 not null;
            alter table settlement_items add currency varchar not null;
        </sql>
    </changeSet>

    <changeSet id="2022-03-28 13:45" author="mert.okan">
        <sql>
            alter table commission_invoices add constraint commission_invoices_serial_number_key unique (serial_number);
        </sql>
    </changeSet>

    <changeSet id="2022-03-29 17:00" author="mert.okan">
        <sql>
            alter table commission_invoices add reference_id varchar not null;
            alter table commission_invoices add constraint commission_invoices_reference_id_key unique (reference_id);
        </sql>
    </changeSet>

    <changeSet id="2022-03-30 15:30" author="mert.okan">
        <sql>
            alter table commission_invoices alter column serial_number drop not null;
        </sql>
    </changeSet>

    <changeSet id="2022-03-30 15:30" author="ilker.okan">
        <sql>
            create index idx_commission_invoice_status on commission_invoices(status);
        </sql>
    </changeSet>

    <changeSet id="2022-04-18 11:20" author="mert.okan">
        <sql>
            create table if not exists shovel_exceptions
            (
                id                         varchar(255),
                created_date               timestamp not null,
                last_modified_date         timestamp not null,
                topic                      varchar(255),
                key                        varchar(255),
                content                    jsonb,
                exception_type             varchar(255),
                content_class_type         varchar(255),
                primary key (id)
            );
        </sql>
    </changeSet>
</databaseChangeLog>
